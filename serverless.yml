service: vehicle-tracking-boilerplate

provider:
  name: aws
  runtime: nodejs10.x
  stage: ${opt:stage, 'dev'}
  region: eu-west-1
  iamRoleStatements:
    # TODO Fine tune if you want. This only ensure your lambda has access to every services
    - Effect: "Allow"
      Action:
        - "*"
      Resource: "*"

functions:
  vehicle-tracker-request:
    handler: index.requestTracker
    description: "Gets location for a vehicle given id"
    events: # events that trigger this action
      - http: # creates an API gateway endpoint
          method: GET
          path: /request/{id}

  vehicle-status-poller:
    handler: index.startPolling
    description: "Starts location tracking for a vehicle"

  vehicle-status-retrieve:
    handler: index.getVehicleStatus
    description: "Retrieves location of a vehicle"
    events: # events that trigger this action
      - http: # creates an API gateway endpoint
          method: GET
          path: /retreive/{id}

package:
  exclude:
    - "node_modules/aws-sdk/**"

custom:
  webpack:
    webpackConfig: "webpack.config.js" # Name of webpack configuration file
    includeModules: false # Node modules configuration for packaging
    packager: "npm" # Packager that will be used to package your external modules
    excludeFiles: src/**/*.test.js # Provide a glob for files to ignore
  TransitTable:
    name: !Ref VehicleStatusTable
    arn: !GetAtt VehicleStatusTable.Arn

plugins:
  - serverless-webpack
  - serverless-pseudo-parameters

resources:
  Resources:
    VehicleStatusTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Transit-Table-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
    TrackedVehicles:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: TrackedVehicles-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
